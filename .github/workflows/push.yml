name: CI

on:
  push:
    branches-ignore:
      - main
      - master

env:
  CI: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    environment: development
    container: node:24
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cache node modules
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          CI_DIRECTUS_TOKEN: ${{ secrets.CI_DIRECTUS_TOKEN }}
          CI_ISR_TOKEN: ${{ secrets.CI_ISR_TOKEN }}

      - name: Linter
        run: npm run lint

      - name: Type checking
        run: npm run check-types

      - name: Run unit tests
        run: npm run test

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Install Playwright (used for Storybook and E2E tests)
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npx percy exec -- npm run test:e2e
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          CI_DIRECTUS_TOKEN: ${{ secrets.CI_DIRECTUS_TOKEN }}

      - name: Archive production artifacts
        uses: actions/upload-artifact@v6
        with:
          name: production-artifacts
          retention-days: 3
          include-hidden-files: true
          path: |
            .next/standalone/
            public/
            .next/static/

  build-docker:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      BRANCH_NAME: ${{ github.ref_name }}
    outputs:
      image_tag: ${{ steps.image-tag.outputs.value }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: production-artifacts

      - name: Derive image tag
        id: image-tag
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [ "${{ github.ref }}" = "refs/heads/development" ]; then
            TAG="$SHORT_SHA"
          else
            SAFE_BRANCH=$(echo "${BRANCH_NAME}" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9_.-' '-')
            TAG="${SAFE_BRANCH}-${SHORT_SHA}"
          fi
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          echo "value=$TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Build
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/webcv:${{ env.IMAGE_TAG }}
          platforms: linux/amd64,linux/arm64

  deploy-development:
    needs: build-docker
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/development' }}
    permissions:
      contents: read
      packages: write
    env:
      IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Pulumi dependencies
        run: npm install
        working-directory: deploy

      - name: Decode kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
        shell: bash

      - name: Deploy to development with Pulumi
        uses: pulumi/actions@v6
        with:
          command: up
          stack-name: dev
          work-dir: deploy
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          registryImage: ${{ secrets.DOCKERHUB_USERNAME }}/webcv
          imageTag: ${{ env.IMAGE_TAG }}
          GHCR_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          GHCR_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          GHCR_REGISTRY: docker.io
